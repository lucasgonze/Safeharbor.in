<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>routes&#x2F;profile-routes.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.1&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.5.1&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Enables filtering in class lists..html">Enables filtering in class lists.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings..html">Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised date and time strings..html">Namespace container for the JsWorld library objects..Class for parsing localised date and time strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised number strings..html">Namespace container for the JsWorld library objects..Class for parsing localised number strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;.html">Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: routes&#x2F;profile-routes.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

&#x2F;***********************************************************
 * Login, logout, edit profile, reset password, edit site
 ***********************************************************&#x2F;

var safeharbor = require(&#x27;..&#x2F;lib&#x2F;safeharbor.js&#x27;);
var debug      = safeharbor.debug;
var utils      = safeharbor.utils;
var errlib     = safeharbor.errors;
var page       = safeharbor.page;
var loginstate = safeharbor.loginstate;
var Performer  = safeharbor.Performer;

var util    = require(&#x27;util&#x27;);
var profile = require(&quot;..&#x2F;models&#x2F;profile-models.js&quot;);

var CODES          = profile.CODES;
var exp            = errlib.err;
var errout         = errlib.errout();

&#x2F;*--------------------------
    EXPORTED
----------------------------*&#x2F;

exports.install = function( app )
{
    var not_logged_in = app.checkRole(app.ROLES.not_logged_in),
        logged_in = app.checkRole(app.ROLES.logged_in);
    
	app.trivialRoute(&#x27;&#x2F;login&#x27;,&#x27;login&#x27;,&#x27;profile&#x27;,&#x27;Log In&#x27;,not_logged_in);
	app.post(&#x27;&#x2F;login&#x27;, not_logged_in, saveLogin);

	app.trivialRoute(&#x27;&#x2F;logout&#x27;,&#x27;logout&#x27;,&#x27;profile&#x27;,&#x27;Log Out&#x27;,logged_in);
	app.post(&#x27;&#x2F;logout&#x27;, logged_in, clearLogin);
		
	app.trivialRoute(&#x27;&#x2F;lostpassword&#x27;,&#x27;lostpassword&#x27;,&#x27;profile&#x27;,&#x27;Lost Password&#x27;,not_logged_in);
	app.post(&#x27;&#x2F;lostpassword&#x27;,                             not_logged_in, lostPasswordStart);	
	app.get (&#x27;&#x2F;lostpassword&#x2F;:resetSecret([0-9a-z]{10})$&#x27;, not_logged_in, lostPasswordGet );
	app.post(&#x27;&#x2F;lostpassword&#x2F;:resetSecret([0-9a-z]{10})$&#x27;, not_logged_in, lostPasswordPost);
	
	app.trivialRoute(&#x27;&#x2F;passwordreset&#x27;,&#x27;passwordreset&#x27;,&#x27;profile&#x27;,&#x27;Reset Password&#x27;,logged_in);
	app.post(&#x27;&#x2F;passwordreset&#x27;, logged_in, savePasswordReset);
	
	app.trivialRoute(&#x27;&#x2F;accountdeleter&#x27;,&#x27;delete&#x27;,&#x27;profile&#x27;,&#x27;Delete Account&#x27;,logged_in);
	app.post(&#x27;&#x2F;accountdeleter&#x27;, logged_in, deleteAccount);

	app.get(&#x27;&#x2F;siteeditor&#x27;, emitSiteEditor,logged_in);
	app.post(&#x27;&#x2F;siteeditor&#x27;, logged_in, saveSiteEdit);
	
	app.get(&#x27;&#x2F;accteditor&#x27;, emitAcctEditor,logged_in);
	app.post(&#x27;&#x2F;accteditor&#x27;, logged_in, saveAcctEditor);
	
}


&#x2F;*--------------------------
    URL Handlers
----------------------------*&#x2F;

&#x2F;&#x2F; log out
function clearLogin(req,res) {
	loginstate.disable(req);
	res.redirect(&quot;&#x2F;login&quot;);
}

function saveLogin(req,res) {
	
    var model = profile.acctFromEmailPassword( req.body, function(code,acct) { 
        if( code == CODES.SUCCESS )
        {
            loginstate.enable(req,acct);
            res.redirect(&quot;&#x2F;dash&quot;);
        }
        else if( code == CODES.NO_RECORDS_FOUND )
        {
            errout( req, res, exp( 400, &#x27;Unauthorized&#x27;)  );
        }
    });

    model.handleErrors( req, res ).perform();
}

function resetPasswordEmail(req, res, to) {	
    return new Performer( 
            { 
                &#x2F;&#x2F; N.B. these params are flipped coming from sendgrid
                callback: function(success,message) {
                    if( success ) {
                        res.outputMessage( 
                            page.MESSAGE_LEVELS.success,
                            &quot;Password reset in progress!&quot;,
                            &quot;Check your email for a link to reset your password.&quot;,
                            { quicktip: &quot;If you do not get a message in your inbox, either there is no account for this email or your spam filter is deleting our mail.&quot; }
                        );
                    
                        res.render( page.MESSAGE_VIEW,
                                    { pageTitle:&quot;Password Reset&quot;, 
                                      bodyClass: &quot;profile&quot;});			
                    }   
                    else {
                        errout( req, res, exp( 400, &#x27;Email reset failed: &#x27; + message)  );
                        this.stopChain();
                    }
                },
                
                performer: function() {            
                    var backlink = &quot;http:&#x2F;&#x2F;&quot;+req.headers.host+&quot;&#x2F;lostpassword&#x2F;&quot;+this.prev.resetSecret,
                        subject = &quot;Password reset for Safeharbor.in&quot;,
                        plainOldAscii = &quot;To reset your password go to &quot;+backlink,
                        htmlTemplate = &quot;&#x2F;..&#x2F;views&#x2F;profile&#x2F;theemail.html&quot;,
                        htmlVars = {&#x27;backlink&#x27;:backlink},
                        sendgrid = require(&#x27;..&#x2F;lib&#x2F;mail.js&#x27;);
                        sendgrid.emailFromTemplate(to,subject,plainOldAscii,
                                                  htmlTemplate,htmlVars,this.bound_callback());
                 }                
            });            
}

&#x2F;&#x2F; save a secret to the DB and email it to the email. note that we always show the &quot;email sent&quot; page, 
&#x2F;&#x2F; but we only actually send the email if it was found in the db!
function lostPasswordStart(req,res){
    var email = req.body.email;
    var rpe = resetPasswordEmail( req, res, email );
	var init = profile.initPasswordReset( email, function( c, resetSecret ) { 
	        if( c == CODES.OK )
	            this.resetSecret = resetSecret;
	    } );

	init
	  .handleErrors(req,res)
	  .chain( rpe )
	  .perform();
}

&#x2F;&#x2F; given that the user has passed a password recovery token in the URL, send
&#x2F;&#x2F; them to the password reset form.
function lostPasswordGet(req,res){
	var vars = { pageTitle:   &quot;Enter New Password&quot;,
	             bodyClass:   &quot;profile&quot;, 
	             resetSecret: req.params.resetSecret
	             };
	res.render(&quot;profile&#x2F;newpasswordform.html&quot;,vars);			
}

&#x2F;&#x2F; given that the user has passed a password recovery token in the URL, check it in 
&#x2F;&#x2F; the db and send them on to the password reset page if it checks out.
function lostPasswordPost(req,res){ 

    var args = { password:    req.body.password, 
                 resetsecret: req.params.resetSecret }; 

    function cb(code,err) {
        if( code == CODES.SUCCESS )
        {
            var title = &quot;Password Recovered&quot;;
            res.outputMessage( 
                page.MESSAGE_LEVELS.success,
                title,
                &quot;Once you were lost, but now it&#x27;s found&quot;
            );
        
            res.render( page.MESSAGE_VIEW, {pageTitle:title} );
        }
    }
    
    profile
      .saveNewPassword( args, cb)
      .handleErrors( req, res, [CODES.NO_RECORDS_FOUND]  )
      .perform();
}

&#x2F;* Different than lostPasswordPost in that it&#x27;s used by a logged-in 
   user rather than one who has lost their password. *&#x2F;
function savePasswordReset(req,res) {

    var args = utils.copy( { acct: loginstate.getID(req) }, req.body );
    
    var resetPW = profile.resetPasswordForLoggedInUser( args, function(code,err) {   
            var title = &quot;Password&quot;;
            if( code == CODES.SUCCESS )
            {
                res.outputMessage( 
                    page.MESSAGE_LEVELS.success,
                    title,
                    &quot;Password successfully reset.&quot;
                );            
            }
            else if( code == CODES.NO_RECORDS_UPDATED )
            {
                res.outputMessage( 
                    page.MESSAGE_LEVELS.error,
                    title,
                    &quot;Invalid current password for account. Passord not reset.&quot;
                );            
            }
          
            res.render( page.MESSAGE_VIEW, {pageTitle:title} );
            
        } );
        
    resetPW.handleErrors( req, res ).perform();
}

function deleteAccount(req,res)
{
	profile.deleteAccount(req.session.userid,function(code,err){
	    if( code == CODES.SUCCESS )
	    {
            loginstate.disable(req);
            var title = &quot;Account Deleted&quot;;
            res.outputMessage( 
                page.MESSAGE_LEVELS.success,
                title,
                &quot;Your account is gone. Thanks for hanging out with us.&quot;
            );    
            res.render( page.MESSAGE_VIEW, {pageTitle:title} );
        }
        else
        {
            &#x2F;&#x2F; TODO: account missing
        }
        
	}).handleErrors(req,res).perform();
}

function emitSiteEditor(req,res){	
	
	var uid = loginstate.getID(req);

    function success(code, site) {
        if( code == CODES.OK )
        {
            res.render(&quot;profile&#x2F;siteeditor.html&quot;, utils.copy({
                                                    pagetitle: &quot;Edit Site&quot;,
                                                    bodyClass: &quot;siteeditor&quot; }, site) );
        }
    }
    
	profile
	    .getSiteForUser( uid, success )
	    .handleErrors( req, res, [CODES.NO_RECORDS_FOUND] )
	    .perform();
}

function saveSiteEdit(req,res) {

    var uid = loginstate.getID(req);
    
    function callback( code, err ) {
        if( code == CODES.OK )
        {
            var title = &quot;Site Properties&quot;;
            res.outputMessage( 
                page.MESSAGE_LEVELS.success,
                title,
                &quot;Changes to site saved.&quot;
            );    
            res.render( page.MESSAGE_VIEW, {pageTitle:title} );
        }
    }            
    var args = utils.copy( {acct: uid}, req.body );

    profile
        .updateSiteForUser( args, callback )
        .handleErrors( req, res )
        .perform();
}


function emitAcctEditor(req,res){	

    var uid = loginstate.getID(req);

    function showEditor( code, acct ) {
        debug.out(&#x27;Show editor: &#x27;, code, acct );
	    if( code == CODES.OK )
	    {
            var vars = utils.copy({ 
                         pagetitle: &quot;Edit Your Account&quot;,
                         bodyClass: &quot;siteeditor&quot; }, acct);
        
            res.render(&quot;profile&#x2F;accteditor.html&quot;, vars );
        }
            
    }	
    
	profile
	  .acctFromID( uid, showEditor )
	  .handleErrors( req, res, [CODES.NO_RECORDS_FOUND] )
	  .perform();
}

function saveAcctEditor(req,res) {

    function setSessionUser(code,acct) 
    { 
        if( code=!CODES.OK )
            return;
            
        loginstate.enable(req,acct); 

        var title = &quot;Account changes saved.&quot;;
        res.outputMessage( 
                page.MESSAGE_LEVELS.success,
                title,
                &quot;Changes to your account have been saved.&quot;
            );    
        res.render( page.MESSAGE_VIEW, {pageTitle:title} );
    };
    
    var uid = loginstate.getID(req);
    var args = utils.copy( {acct: uid, autologin: &#x27;0&#x27;}, req.body )

    args.autologin = args.autologin.replace(&#x2F;on&#x2F;,&#x27;1&#x27;) &gt;&gt;&gt; 0;

    profile
       .updateAccount( args, function(){} )
       .handleErrors(  req, res )
       .chain( profile.acctFromID( uid, setSessionUser )  )
       .perform();
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
