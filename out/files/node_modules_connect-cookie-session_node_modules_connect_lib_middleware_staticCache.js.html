<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>node_modules&#x2F;connect-cookie-session&#x2F;node_modules&#x2F;connect&#x2F;lib&#x2F;middleware&#x2F;staticCache.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.1&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.5.1&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Enables filtering in class lists..html">Enables filtering in class lists.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings..html">Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised date and time strings..html">Namespace container for the JsWorld library objects..Class for parsing localised date and time strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised number strings..html">Namespace container for the JsWorld library objects..Class for parsing localised number strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;.html">Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: node_modules&#x2F;connect-cookie-session&#x2F;node_modules&#x2F;connect&#x2F;lib&#x2F;middleware&#x2F;staticCache.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

&#x2F;*!
 * Connect - staticCache
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 *&#x2F;

&#x2F;**
 * Module dependencies.
 *&#x2F;

var http = require(&#x27;http&#x27;)
  , utils = require(&#x27;..&#x2F;utils&#x27;)
  , Cache = require(&#x27;..&#x2F;cache&#x27;)
  , url = require(&#x27;url&#x27;)
  , fs = require(&#x27;fs&#x27;);

&#x2F;**
 * Static cache:
 *
 * Enables a memory cache layer on top of
 * the &#x60;static()&#x60; middleware, serving popular
 * static files.
 *
 * By default a maximum of 128 objects are
 * held in cache, with a max of 256k each,
 * totalling ~32mb.
 *
 * A Least-Recently-Used (LRU) cache algo
 * is implemented through the &#x60;Cache&#x60; object,
 * simply rotating cache objects as they are
 * hit. This means that increasingly popular
 * objects maintain their positions while
 * others get shoved out of the stack and
 * garbage collected.
 *
 * Benchmarks:
 *
 *     static(): 2700 rps
 *     node-static: 5300 rps
 *     static() + staticCache(): 7500 rps
 *
 * Options:
 *
 *   - &#x60;maxObjects&#x60;  max cache objects [128]
 *   - &#x60;maxLength&#x60;  max cache object length 256kb
 *
 * @param {Object} options
 * @return {Function}
 * @api public
 *&#x2F;

module.exports = function staticCache(options){
  var options = options || {}
    , cache = new Cache(options.maxObjects || 128)
    , maxlen = options.maxLength || 1024 * 256;

  return function staticCache(req, res, next){
    var key = cacheKey(req)
      , ranges = req.headers.range
      , hit = cache.get(key);

    &#x2F;&#x2F; cache static
    &#x2F;&#x2F; TODO: change from staticCache() -&gt; cache()
    &#x2F;&#x2F; and make this work for any request
    req.on(&#x27;static&#x27;, function(stream){
      var headers = res._headers
        , cc = utils.parseCacheControl(headers[&#x27;cache-control&#x27;] || &#x27;&#x27;)
        , contentLength = headers[&#x27;content-length&#x27;]
        , hit;

      &#x2F;&#x2F; ignore larger files
      if (!contentLength || contentLength &gt; maxlen) return;

      &#x2F;&#x2F; don&#x27;t cache partial files
      if (headers[&#x27;content-range&#x27;]) return;

      &#x2F;&#x2F; dont cache items we shouldn&#x27;t be
      &#x2F;&#x2F; TODO: real support for must-revalidate &#x2F; no-cache
      if ( cc[&#x27;no-cache&#x27;]
        || cc[&#x27;no-store&#x27;]
        || cc[&#x27;private&#x27;]
        || cc[&#x27;must-revalidate&#x27;]) return;

      &#x2F;&#x2F; if already in cache then validate
      if (hit = cache.get(key)){
        if (headers.etag == hit[0].etag) {
          hit[0].date = new Date;
          return;
        } else {
          cache.remove(key);
        }
      }

      &#x2F;&#x2F; validation notifiactions don&#x27;t contain a steam
      if (null == stream) return;

      &#x2F;&#x2F; add the cache object
      var arr = [];

      &#x2F;&#x2F; store the chunks
      stream.on(&#x27;data&#x27;, function(chunk){
        arr.push(chunk);
      });

      &#x2F;&#x2F; flag it as complete
      stream.on(&#x27;end&#x27;, function(){
        var cacheEntry = cache.add(key);
        delete headers[&#x27;x-cache&#x27;]; &#x2F;&#x2F; Clean up (TODO: others)
        cacheEntry.push(200);
        cacheEntry.push(headers);
        cacheEntry.push.apply(cacheEntry, arr);
      });
    });

    if (req.method == &#x27;GET&#x27; || req.method == &#x27;HEAD&#x27;) {
      if (ranges) {
        next();
      } else if (hit &amp;&amp; !mustRevalidate(req, hit)) {
        res.setHeader(&#x27;X-Cache&#x27;, &#x27;HIT&#x27;);
        respondFromCache(req, res, hit);
      } else {
        res.setHeader(&#x27;X-Cache&#x27;, &#x27;MISS&#x27;);
        next();
      }
    } else {
      next();
    }
  }
};

&#x2F;**
 * Respond with the provided cached value.
 * TODO: Assume 200 code, that&#x27;s iffy.
 *
 * @param {Object} req
 * @param {Object} res
 * @param {Object} cacheEntry
 * @return {String}
 * @api private
 *&#x2F;

function respondFromCache(req, res, cacheEntry) {
  var status = cacheEntry[0]
    , headers = utils.merge({}, cacheEntry[1])
    , content = cacheEntry.slice(2);

  headers.age = (new Date - new Date(headers.date)) &#x2F; 1000 || 0;

  switch (req.method) {
    case &#x27;HEAD&#x27;:
      res.writeHead(status, headers);
      res.end();
      break;
    case &#x27;GET&#x27;:
      if (utils.conditionalGET(req) &amp;&amp; !utils.modified(req, res, headers)) {
        header[&#x27;content-length&#x27;] = 0;
        res.writeHead(304, headers);
        res.end();
      } else {
        res.writeHead(status, headers);

        function write() {
          while (content.length) {
            if (false === res.write(content.shift())) {
              res.once(&#x27;drain&#x27;, write);
              return;
            }
          }
          res.end();
        }

        write();
      }
      break;
    default:
      &#x2F;&#x2F; This should never happen.
      res.writeHead(500, &#x27;&#x27;);
      res.end();
  }
}

&#x2F;**
 * Determine whether or not a cached value must be revalidated.
 *
 * @param {Object} req
 * @param {Object} cacheEntry
 * @return {String}
 * @api private
 *&#x2F;

function mustRevalidate(req, cacheEntry) {
  var cacheHeaders = cacheEntry[1]
    , reqCC = utils.parseCacheControl(req.headers[&#x27;cache-control&#x27;] || &#x27;&#x27;)
    , cacheCC = utils.parseCacheControl(cacheHeaders[&#x27;cache-control&#x27;] || &#x27;&#x27;)
    , cacheAge = (new Date - new Date(cacheHeaders.date)) &#x2F; 1000 || 0;

  if ( cacheCC[&#x27;no-cache&#x27;]
    || cacheCC[&#x27;must-revalidate&#x27;]
    || cacheCC[&#x27;proxy-revalidate&#x27;]) return true;

  if (reqCC[&#x27;no-cache&#x27;]) return true

  if (null != reqCC[&#x27;max-age&#x27;]) return reqCC[&#x27;max-age&#x27;] &lt; cacheAge;

  if (null != cacheCC[&#x27;max-age&#x27;]) return cacheCC[&#x27;max-age&#x27;] &lt; cacheAge;

  return false;
}

&#x2F;**
 * The key to use in the cache. For now, this is the URL path and query.
 *
 * &#x27;http:&#x2F;&#x2F;example.com?key=value&#x27; -&gt; &#x27;&#x2F;?key=value&#x27;
 *
 * @param {Object} req
 * @return {String}
 * @api private
 *&#x2F;

function cacheKey(req) {
  return utils.parseUrl(req).path;
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
