<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>node_modules&#x2F;sendgrid&#x2F;node_modules&#x2F;nodemailer&#x2F;node_modules&#x2F;mailcomposer&#x2F;lib&#x2F;dkim.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.1&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.5.1&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Enables filtering in class lists..html">Enables filtering in class lists.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings..html">Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised date and time strings..html">Namespace container for the JsWorld library objects..Class for parsing localised date and time strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised number strings..html">Namespace container for the JsWorld library objects..Class for parsing localised number strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;.html">Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: node_modules&#x2F;sendgrid&#x2F;node_modules&#x2F;nodemailer&#x2F;node_modules&#x2F;mailcomposer&#x2F;lib&#x2F;dkim.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var crypto = require(&quot;crypto&quot;),
    mimelib = require(&quot;mimelib-noiconv&quot;),
    toPunycode = require(&quot;.&#x2F;punycode&quot;);

&#x2F;**
 * @namespace DKIM Signer module 
 * @name dkimsign
 *&#x2F;
module.exports.DKIMSign = DKIMSign;
module.exports.generateDKIMHeader = generateDKIMHeader;
module.exports.sha256 = sha256;


&#x2F;**
 * &lt;p&gt;Sign an email with provided DKIM key, uses RSA-SHA256.&lt;&#x2F;p&gt;
 * 
 * @memberOf dkimsign
 * @param {String} email Full e-mail source complete with headers and body to sign
 * @param {Object} options DKIM options
 * @param {String} [options.headerFieldNames=&quot;from:to:cc:subject&quot;] Header fields to sign
 * @param {String} options.privateKey DKMI private key 
 * @param {String} options.domainName Domain name to use for signing (ie: &quot;domain.com&quot;)
 * @param {String} options.keySelector Selector for the DKMI public key (ie. &quot;dkim&quot; if you have set up a TXT record for &quot;dkim._domainkey.domain.com&quot;)
 * 
 * @return {String} Signed DKIM-Signature header field for prepending 
 *&#x2F;
function DKIMSign(email, options){
    options = options || {};
    email = (email || &quot;&quot;).toString(&quot;utf-8&quot;);
    
    var match = email.match(&#x2F;^\r?\n|(?:\r?\n){2}&#x2F;),
        headers = match &amp;&amp; email.substr(0, match.index) || &quot;&quot;,
        body = match &amp;&amp; email.substr(match.index + match[0].length) || email;
    
    &#x2F;&#x2F; all listed fields from RFC4871 #5.5
    var defaultFieldNames = &quot;From:Sender:Reply-To:Subject:Date:Message-ID:To:&quot; +
            &quot;Cc:MIME-Version:Content-Type:Content-Transfer-Encoding:Content-ID:&quot; +
            &quot;Content-Description:Resent-Date:Resent-From:Resent-Sender:&quot; +
            &quot;Resent-To:Resent-Cc:Resent-Message-ID:In-Reply-To:References:&quot; +
            &quot;List-Id:List-Help:List-Unsubscribe:List-Subscribe:List-Post:&quot; +
            &quot;List-Owner:List-Archive&quot;;
    
    var dkim = generateDKIMHeader(options.domainName, options.keySelector, options.headerFieldNames || defaultFieldNames, headers, body),
        canonicalizedHeaderData = DKIMCanonicalizer.relaxedHeaders(headers, options.headerFieldNames || defaultFieldNames),
        canonicalizedDKIMHeader = DKIMCanonicalizer.relaxedHeaderLine(dkim),
        signer, signature;

    canonicalizedHeaderData.headers +=  canonicalizedDKIMHeader.key+&quot;:&quot;+canonicalizedDKIMHeader.value;

    signer = crypto.createSign(&quot;RSA-SHA256&quot;);
    signer.update(canonicalizedHeaderData.headers);
    signature = signer.sign(options.privateKey, &#x27;base64&#x27;);
    
    return dkim + signature.replace(&#x2F;(.{76}(?!\r?\n|\r))&#x2F;g,&quot;$&amp;\r\n        &quot;);
}

&#x2F;**
 * &lt;p&gt;Generates a DKIM-Signature header field without the signature part (&quot;b=&quot; is empty)&lt;&#x2F;p&gt;
 * 
 * @memberOf dkimsign
 * @private
 * @param {String} domainName Domain name to use for signing
 * @param {String} keySelector Selector for the DKMI public key
 * @param {String} headerFieldNames Header fields to sign
 * @param {String} headers E-mail headers
 * @param {String} body E-mail body
 * 
 * @return {String} Mime folded DKIM-Signature string
 *&#x2F;
function generateDKIMHeader(domainName, keySelector, headerFieldNames, headers, body){
    var canonicalizedBody = DKIMCanonicalizer.relaxedBody(body),
        canonicalizedBodyHash = sha256(canonicalizedBody, &quot;base64&quot;),
        canonicalizedHeaderData = DKIMCanonicalizer.relaxedHeaders(headers, headerFieldNames),
        dkim;

    if(hasUTFChars(domainName)){
        domainName = toPunycode(domainName);
    }

    dkim = [
        &quot;v=1&quot;,
        &quot;a=rsa-sha256&quot;,
        &quot;c=relaxed&#x2F;relaxed&quot;,
        &quot;d=&quot;+domainName,
        &quot;q=dns&#x2F;txt&quot;,
        &quot;s=&quot;+keySelector,
        &quot;bh=&quot;+canonicalizedBodyHash,
        &quot;h=&quot;+canonicalizedHeaderData.fieldNames
    ].join(&quot;; &quot;);

    return mimelib.foldLine(&quot;DKIM-Signature: &quot; + dkim, 76)+&quot;;\r\n        b=&quot;;
}

&#x2F;**
 * &lt;p&gt;DKIM canonicalization functions&lt;&#x2F;p&gt;
 * 
 * @memberOf dkimsign
 * @private
 *&#x2F;
var DKIMCanonicalizer = {
   
    &#x2F;**
     * &lt;p&gt;Simple body canonicalization by rfc4871 #3.4.3&lt;&#x2F;p&gt;
     * 
     * @param {String} body E-mail body part
     * @return {String} Canonicalized body
     *&#x2F;
    simpleBody: function(body){
        return (body || &quot;&quot;).toString().replace(&#x2F;(?:\r?\n|\r)*$&#x2F;, &quot;\r\n&quot;);
    },
    
    &#x2F;**
     * &lt;p&gt;Relaxed body canonicalization by rfc4871 #3.4.4&lt;&#x2F;p&gt;
     * 
     * @param {String} body E-mail body part
     * @return {String} Canonicalized body
     *&#x2F;
    relaxedBody: function(body){
        return (body || &quot;&quot;).toString().
                replace(&#x2F;\r?\n|\r&#x2F;g, &quot;\n&quot;).
                split(&quot;\n&quot;).
                map(function(line){
                    return line.replace(&#x2F;\s*$&#x2F;, &quot;&quot;). &#x2F;&#x2F;rtrim
                                replace(&#x2F;\s+&#x2F;g, &quot; &quot;); &#x2F;&#x2F; only single spaces
                }).
                join(&quot;\n&quot;).
                replace(&#x2F;\n*$&#x2F;, &quot;\n&quot;).
                replace(&#x2F;\n&#x2F;g, &quot;\r\n&quot;);
    },
    
    &#x2F;**
     * &lt;p&gt;Relaxed headers canonicalization by rfc4871 #3.4.2 with filtering&lt;&#x2F;p&gt;
     * 
     * @param {String} body E-mail headers part
     * @return {String} Canonicalized headers
     *&#x2F;
    relaxedHeaders: function(headers, fieldNames){
        var includedFields = (fieldNames || &quot;&quot;).toLowerCase().
                                split(&quot;:&quot;).
                                map(function(field){
                                    return field.trim();
                                }),
            headerFields = {},
            headerLines = headers.split(&#x2F;\r?\n|\r&#x2F;),
            line, i;
        
        &#x2F;&#x2F; join lines
        for(i = headerLines.length-1; i&gt;=0; i--){
            if(i &amp;&amp; headerLines[i].match(&#x2F;^\s&#x2F;)){
                headerLines[i-1] += headerLines.splice(i,1);
            }else{
                line = DKIMCanonicalizer.relaxedHeaderLine(headerLines[i]);

                &#x2F;&#x2F; on multiple values, include only the first one (the one in the bottom of the list)
                if(includedFields.indexOf(line.key) &gt;= 0 &amp;&amp; !(line.key in headerFields)){
                    headerFields[line.key] = line.value;
                }
            }
        }

        headers = [];
        for(i = includedFields.length-1; i&gt;=0; i--){
            if(!headerFields[includedFields[i]]){
                includedFields.splice(i,1);
            }else{
                headers.unshift(includedFields[i]+&quot;:&quot;+headerFields[includedFields[i]]);
            }
        }

        return {
            headers: headers.join(&quot;\r\n&quot;)+&quot;\r\n&quot;,
            fieldNames: includedFields.join(&quot;:&quot;)
        };
    },
    
    &#x2F;**
     * &lt;p&gt;Relaxed header canonicalization for single header line&lt;&#x2F;p&gt;
     * 
     * @param {String} line Single header line
     * @return {String} Canonicalized header line
     *&#x2F;
    relaxedHeaderLine: function(line){
        var value = line.split(&quot;:&quot;),
            key = (value.shift() || &quot;&quot;).toLowerCase().trim();
        
        value = value.join(&quot;:&quot;).replace(&#x2F;\s+&#x2F;g, &quot; &quot;).trim();
        
        return {key: key, value: value};
    }
};
module.exports.DKIMCanonicalizer = DKIMCanonicalizer;

&#x2F;**
 * &lt;p&gt;Generates a SHA-256 hash&lt;&#x2F;p&gt;
 * 
 * @param {String} str String to be hashed
 * @param {String} [encoding=&quot;hex&quot;] Output encoding
 * @return {String} SHA-256 hash in the selected output encoding
 *&#x2F;
function sha256(str, encoding){
    var shasum = crypto.createHash(&#x27;sha256&#x27;);
    shasum.update(str);
    return shasum.digest(encoding || &quot;hex&quot;);
}



&#x2F;**
 * &lt;p&gt;Detects if a string includes unicode symbols&lt;&#x2F;p&gt;
 * 
 * @param {String} str String to be checked
 * @return {String} true, if string contains non-ascii symbols
 *&#x2F;
function hasUTFChars(str){
    var rforeign = &#x2F;[^\u0000-\u007f]&#x2F;;
    return !!rforeign.test(str);
}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
