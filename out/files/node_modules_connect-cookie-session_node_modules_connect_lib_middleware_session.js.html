<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>node_modules&#x2F;connect-cookie-session&#x2F;node_modules&#x2F;connect&#x2F;lib&#x2F;middleware&#x2F;session.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.1&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.5.1&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Enables filtering in class lists..html">Enables filtering in class lists.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings..html">Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised date and time strings..html">Namespace container for the JsWorld library objects..Class for parsing localised date and time strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised number strings..html">Namespace container for the JsWorld library objects..Class for parsing localised number strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;.html">Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: node_modules&#x2F;connect-cookie-session&#x2F;node_modules&#x2F;connect&#x2F;lib&#x2F;middleware&#x2F;session.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

&#x2F;*!
 * Connect - session
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 *&#x2F;

&#x2F;**
 * Module dependencies.
 *&#x2F;

var Session = require(&#x27;.&#x2F;session&#x2F;session&#x27;)
  , debug = require(&#x27;debug&#x27;)(&#x27;connect:session&#x27;)
  , MemoryStore = require(&#x27;.&#x2F;session&#x2F;memory&#x27;)
  , Cookie = require(&#x27;.&#x2F;session&#x2F;cookie&#x27;)
  , Store = require(&#x27;.&#x2F;session&#x2F;store&#x27;)
  , utils = require(&#x27;.&#x2F;..&#x2F;utils&#x27;)
  , parse = utils.parseUrl
  , crc16 = require(&#x27;crc&#x27;).crc16
  , crypto = require(&#x27;crypto&#x27;);

&#x2F;&#x2F; environment

var env = process.env.NODE_ENV;

&#x2F;**
 * Expose the middleware.
 *&#x2F;

exports = module.exports = session;

&#x2F;**
 * Expose constructors.
 *&#x2F;

exports.Store = Store;
exports.Cookie = Cookie;
exports.Session = Session;
exports.MemoryStore = MemoryStore;

&#x2F;**
 * Warning message for &#x60;MemoryStore&#x60; usage in production.
 *&#x2F;

var warning = &#x27;Warning: connection.session() MemoryStore is not\n&#x27;
  + &#x27;designed for a production environment, as it will leak\n&#x27;
  + &#x27;memory, and will not scale past a single process.&#x27;;

&#x2F;**
 * Session:
 * 
 *   Setup session store with the given &#x60;options&#x60;.
 *
 *   Session data is _not_ saved in the cookie itself, however
 *   cookies are used, so we must use the [cookieParser()](cookieParser.html)
 *   middleware _before_ &#x60;session()&#x60;.
 *
 * Examples:
 *
 *     connect()
 *       .use(connect.cookieParser(&#x27;keyboard cat&#x27;))
 *       .use(connect.session({ key: &#x27;sid&#x27;, cookie: { secure: true }}))
 *
 * Options:
 *
 *   - &#x60;key&#x60; cookie name defaulting to &#x60;connect.sid&#x60;
 *   - &#x60;store&#x60; session store instance
 *   - &#x60;cookie&#x60; session cookie settings, defaulting to &#x60;{ path: &#x27;&#x2F;&#x27;, httpOnly: true, maxAge: null }&#x60;
 *   - &#x60;proxy&#x60; trust the reverse proxy when setting secure cookies (via &quot;x-forwarded-proto&quot;)
 *
 * Cookie option:
 *
 *  By default &#x60;cookie.maxAge&#x60; is &#x60;null&#x60;, meaning no &quot;expires&quot; parameter is set
 *  so the cookie becomes a browser-session cookie. When the user closes the 
 *  browser the cookie (and session) will be removed.
 *
 * ## req.session
 *
 *  To store or access session data, simply use the request property &#x60;req.session&#x60;,
 *  which is (generally) serialized as JSON by the store, so nested objects 
 *  are typically fine. For example below is a user-specific view counter:
 *
 *       connect()
 *         .use(connect.favicon())
 *         .use(connect.cookieParser(&#x27;keyboard cat&#x27;))
 *         .use(connect.session({ cookie: { maxAge: 60000 }}))
 *         .use(function(req, res, next){
 *           var sess = req.session;
 *           if (sess.views) {
 *             res.setHeader(&#x27;Content-Type&#x27;, &#x27;text&#x2F;html&#x27;);
 *             res.write(&#x27;&lt;p&gt;views: &#x27; + sess.views + &#x27;&lt;&#x2F;p&gt;&#x27;);
 *             res.write(&#x27;&lt;p&gt;expires in: &#x27; + (sess.cookie.maxAge &#x2F; 1000) + &#x27;s&lt;&#x2F;p&gt;&#x27;);
 *             res.end();
 *             sess.views++;
 *           } else {
 *             sess.views = 1;
 *             res.end(&#x27;welcome to the session demo. refresh!&#x27;);
 *           }
 *         }
 *       )).listen(3000);
 *
 * ## Session#regenerate()
 *
 *  To regenerate the session simply invoke the method, once complete
 *  a new SID and &#x60;Session&#x60; instance will be initialized at &#x60;req.session&#x60;.
 *
 *      req.session.regenerate(function(err){
 *        &#x2F;&#x2F; will have a new session here
 *      });
 *
 * ## Session#destroy()
 *
 *  Destroys the session, removing &#x60;req.session&#x60;, will be re-generated next request.
 *
 *      req.session.destroy(function(err){
 *        &#x2F;&#x2F; cannot access session here
 *      });
 * 
 * ## Session#reload()
 *
 *  Reloads the session data.
 *
 *      req.session.reload(function(err){
 *        &#x2F;&#x2F; session updated
 *      });
 *
 * ## Session#save()
 *
 *  Save the session.
 *
 *      req.session.save(function(err){
 *        &#x2F;&#x2F; session saved
 *      });
 *
 * ## Session#touch()
 *
 *   Updates the &#x60;.maxAge&#x60; property. Typically this is
 *   not necessary to call, as the session middleware does this for you.
 *
 * ## Session#cookie
 *
 *  Each session has a unique cookie object accompany it. This allows
 *  you to alter the session cookie per visitor. For example we can
 *  set &#x60;req.session.cookie.expires&#x60; to &#x60;false&#x60; to enable the cookie
 *  to remain for only the duration of the user-agent.
 *
 * ## Session#maxAge
 *
 *  Alternatively &#x60;req.session.cookie.maxAge&#x60; will return the time
 *  remaining in milliseconds, which we may also re-assign a new value
 *  to adjust the &#x60;.expires&#x60; property appropriately. The following
 *  are essentially equivalent
 *
 *     var hour = 3600000;
 *     req.session.cookie.expires = new Date(Date.now() + hour);
 *     req.session.cookie.maxAge = hour;
 *
 * For example when &#x60;maxAge&#x60; is set to &#x60;60000&#x60; (one minute), and 30 seconds
 * has elapsed it will return &#x60;30000&#x60; until the current request has completed,
 * at which time &#x60;req.session.touch()&#x60; is called to reset &#x60;req.session.maxAge&#x60;
 * to its original value.
 *
 *     req.session.cookie.maxAge;
 *     &#x2F;&#x2F; =&gt; 30000
 *
 * Session Store Implementation:
 *
 * Every session store _must_ implement the following methods
 *
 *    - &#x60;.get(sid, callback)&#x60;
 *    - &#x60;.set(sid, session, callback)&#x60;
 *    - &#x60;.destroy(sid, callback)&#x60;
 *
 * Recommended methods include, but are not limited to:
 *
 *    - &#x60;.length(callback)&#x60;
 *    - &#x60;.clear(callback)&#x60;
 *
 * For an example implementation view the [connect-redis](http:&#x2F;&#x2F;github.com&#x2F;visionmedia&#x2F;connect-redis) repo.
 *
 * @param {Object} options
 * @return {Function}
 * @api public
 *&#x2F;

function session(options){
  var options = options || {}
    , key = options.key || &#x27;connect.sid&#x27;
    , store = options.store || new MemoryStore
    , cookie = options.cookie
    , trustProxy = options.proxy;

  &#x2F;&#x2F; notify user that this store is not
  &#x2F;&#x2F; meant for a production environment
  if (&#x27;production&#x27; == env &amp;&amp; store instanceof MemoryStore) {
    console.warn(warning);
  }

  &#x2F;&#x2F; generates the new session
  store.generate = function(req){
    req.sessionID = utils.uid(24);
    req.session = new Session(req);
    req.session.cookie = new Cookie(req, cookie);
  };

  return function session(req, res, next) {
    &#x2F;&#x2F; self-awareness
    if (req.session) return next();

    &#x2F;&#x2F; ensure secret is available or bail
    if (!req.secret) throw new Error(&#x27;connect.cookieParser(&quot;secret&quot;) required for security when using sessions&#x27;);

    &#x2F;&#x2F; parse url
    var url = parse(req)
      , path = url.pathname
      , originalHash;

    &#x2F;&#x2F; expose store
    req.sessionStore = store;

    &#x2F;&#x2F; set-cookie
    res.on(&#x27;header&#x27;, function(){
      if (!req.session) return;
      var cookie = req.session.cookie
        , proto = (req.headers[&#x27;x-forwarded-proto&#x27;] || &#x27;&#x27;).toLowerCase()
        , tls = req.connection.encrypted || (trustProxy &amp;&amp; &#x27;https&#x27; == proto)
        , secured = cookie.secure &amp;&amp; tls
        , isNew = req.signedCookies[key] != req.sessionID;

      &#x2F;&#x2F; only send secure cookies via https
      if (cookie.secure &amp;&amp; !secured) return debug(&#x27;not secured&#x27;);

      &#x2F;&#x2F; browser-session length cookie
      if (null == cookie.expires) {
        if (!isNew) return debug(&#x27;already set browser-session cookie&#x27;);
      &#x2F;&#x2F; compare hashes
      } else if (originalHash == hash(req.session)) {
        return debug(&#x27;unmodified session&#x27;);
      }

      var val = cookie.serialize(key, req.sessionID);
      debug(&#x27;set-cookie %s&#x27;, val);
      res.setHeader(&#x27;Set-Cookie&#x27;, val);
    });

    &#x2F;&#x2F; proxy end() to commit the session
    var end = res.end;
    res.end = function(data, encoding){
      res.end = end;
      if (!req.session) return res.end(data, encoding);
      debug(&#x27;saving&#x27;);
      req.session.resetMaxAge();
      req.session.save(function(){
        debug(&#x27;saved&#x27;);
        res.end(data, encoding);
      });
    };

    &#x2F;&#x2F; generate the session
    function generate() {
      store.generate(req);
    }

    &#x2F;&#x2F; get the sessionID from the cookie
    req.sessionID = req.signedCookies[key];

    &#x2F;&#x2F; generate a session if the browser doesn&#x27;t send a sessionID
    if (!req.sessionID) {
      debug(&#x27;no SID sent, generating session&#x27;);
      generate();
      next();
      return;
    }

    &#x2F;&#x2F; generate the session object
    var pause = utils.pause(req);
    debug(&#x27;fetching %s&#x27;, req.sessionID);
    store.get(req.sessionID, function(err, sess){
      &#x2F;&#x2F; proxy to resume() events
      var _next = next;
      next = function(err){
        _next(err);
        pause.resume();
      }

      &#x2F;&#x2F; error handling
      if (err) {
        debug(&#x27;error&#x27;);
        if (&#x27;ENOENT&#x27; == err.code) {
          generate();
          next();
        } else {
          next(err);
        }
      &#x2F;&#x2F; no session
      } else if (!sess) {
        debug(&#x27;no session found&#x27;);
        generate();
        next();
      &#x2F;&#x2F; populate req.session
      } else {
        debug(&#x27;session found&#x27;);
        store.createSession(req, sess);
        originalHash = hash(sess);
        next();
      }
    });
  };
};

&#x2F;**
 * Hash the given &#x60;sess&#x60; object omitting changes
 * to &#x60;.cookie&#x60;.
 *
 * @param {Object} sess
 * @return {String}
 * @api private
 *&#x2F;

function hash(sess) {
  return crc16(JSON.stringify(sess, function(key, val){
    if (&#x27;cookie&#x27; != key) return val;
  }));
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
