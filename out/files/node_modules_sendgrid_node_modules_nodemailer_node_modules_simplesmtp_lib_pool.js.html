<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>node_modules&#x2F;sendgrid&#x2F;node_modules&#x2F;nodemailer&#x2F;node_modules&#x2F;simplesmtp&#x2F;lib&#x2F;pool.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.1&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.5.1&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Enables filtering in class lists..html">Enables filtering in class lists.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings..html">Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised date and time strings..html">Namespace container for the JsWorld library objects..Class for parsing localised date and time strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised number strings..html">Namespace container for the JsWorld library objects..Class for parsing localised number strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;.html">Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: node_modules&#x2F;sendgrid&#x2F;node_modules&#x2F;nodemailer&#x2F;node_modules&#x2F;simplesmtp&#x2F;lib&#x2F;pool.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var simplesmtp = require(&quot;..&#x2F;index&quot;),
    EventEmitter = require(&#x27;events&#x27;).EventEmitter,
    utillib = require(&quot;util&quot;);

&#x2F;&#x2F; expose to the world
module.exports = function(port, host, options){
    var pool = new SMTPConnectionPool(port, host, options);
    return pool;
};

&#x2F;**
 * &lt;p&gt;Creates a SMTP connection pool&lt;&#x2F;p&gt;
 *
 * &lt;p&gt;Optional options object takes the following possible properties:&lt;&#x2F;p&gt;
 * &lt;ul&gt;
 *     &lt;li&gt;&lt;b&gt;secureConnection&lt;&#x2F;b&gt; - use SSL&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;name&lt;&#x2F;b&gt; - the name of the client server&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;auth&lt;&#x2F;b&gt; - authentication object &lt;code&gt;{user:&quot;...&quot;, pass:&quot;...&quot;}&lt;&#x2F;code&gt;
 *     &lt;li&gt;&lt;b&gt;ignoreTLS&lt;&#x2F;b&gt; - ignore server support for STARTTLS&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;debug&lt;&#x2F;b&gt; - output client and server messages to console&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;maxConnections&lt;&#x2F;b&gt; - how many connections to keep in the pool&lt;&#x2F;li&gt;
 * &lt;&#x2F;ul&gt;
 *
 * @constructor
 * @namespace SMTP Client Pool module
 * @param {Number} [port=25] The port number to connecto to
 * @param {String} [host=&quot;localhost&quot;] THe hostname to connect to
 * @param {Object} [options] optional options object
 *&#x2F;
function SMTPConnectionPool(port, host, options){
    EventEmitter.call(this);

    &#x2F;**
     * Port number to connect to
     * @public
     *&#x2F;
    this.port = port || 25;

    &#x2F;**
     * Hostname to connect to
     * @public
     *&#x2F;
    this.host = host || &quot;localhost&quot;;

    &#x2F;**
     * Options object
     * @public
     *&#x2F;
    this.options = options || {};
    this.options.maxConnections = this.options.maxConnections || 5;

    &#x2F;**
     * An array of connections that are currently idle
     * @private
     *&#x2F;
    this._connectionsAvailable = [];

    &#x2F;**
     * An array of connections that are currently in use
     * @private
     *&#x2F;
    this._connectionsInUse = [];

    &#x2F;**
     * Message queue (FIFO)
     * @private
     *&#x2F;
    this._messageQueue = [];

    &#x2F;**
     * Counter for generating ID values for debugging
     * @private
     *&#x2F;
    this._idgen = 0;
}
utillib.inherits(SMTPConnectionPool, EventEmitter);

&#x2F;**
 * &lt;p&gt;Sends a message. If there&#x27;s any idling connections available
 * use one to send the message immediatelly, otherwise add to queue.&lt;&#x2F;p&gt;
 *
 * @param {Object} message MailComposer object
 * @param {Function} callback Callback function to run on finish, gets an
 *        &lt;code&gt;error&lt;&#x2F;code&gt; object as a parameter if the sending failed
 *        and on success an object with &lt;code&gt;failedRecipients&lt;&#x2F;code&gt; array as
 *        a list of addresses that were rejected (if any) and
 *        &lt;code&gt;message&lt;&#x2F;code&gt; which indicates the last message received from
 *        the server
 *&#x2F;
SMTPConnectionPool.prototype.sendMail = function(message, callback){
    var connection;

    message.returnCallback = callback;

    if(this._connectionsAvailable.length){
        &#x2F;&#x2F; if available connections pick one
        connection = this._connectionsAvailable.pop();
        this._connectionsInUse.push(connection);
        this._processMessage(message, connection);
    }else{
        this._messageQueue.push(message);

        if(this._connectionsAvailable.length + this._connectionsInUse.length &lt; this.options.maxConnections){
            this._createConnection();
        }
    }

};

&#x2F;**
 * &lt;p&gt;Closes all connections&lt;&#x2F;p&gt;
 *&#x2F;
SMTPConnectionPool.prototype.close = function(callback){
    var connection;

    &#x2F;&#x2F; for some reason destroying the connections seem to be the only way :S
    while(this._connectionsAvailable.length){
        connection = this._connectionsAvailable.pop();
        if(connection.socket){
            connection.socket.destroy();
        }
    }

    while(this._connectionsInUse.length){
        connection = this._connectionsInUse.pop();
        if(connection.socket){
            connection.socket.destroy();
        }
    }

    if(callback){
        process.nextTick(callback);
    }
};

&#x2F;**
 * &lt;p&gt;Initiates a connection to the SMTP server and adds it to the pool&lt;&#x2F;p&gt;
 *&#x2F;
SMTPConnectionPool.prototype._createConnection = function(){
    var connectionOptions = {
            instanceId: ++this._idgen,
            debug: !!this.options.debug,
            ignoreTLS: !!this.options.ignoreTLS,
            auth: this.options.auth || false,
            authMethod: this.options.authMethod,
            name: this.options.name || false,
            secureConnection: !!this.options.secureConnection
        },
        connection = simplesmtp.connect(this.port, this.host, connectionOptions);

    connection.on(&quot;idle&quot;, this._onConnectionIdle.bind(this, connection));
    connection.on(&quot;message&quot;, this._onConnectionMessage.bind(this, connection));
    connection.on(&quot;ready&quot;, this._onConnectionReady.bind(this, connection));
    connection.on(&quot;error&quot;, this._onConnectionError.bind(this, connection));
    connection.on(&quot;end&quot;, this._onConnectionEnd.bind(this, connection));
    connection.on(&quot;rcptFailed&quot;, this._onConnectionRCPTFailed.bind(this, connection));

    this.emit(&#x27;connectionCreated&#x27;, connection);

    &#x2F;&#x2F; as the connection is not ready yet, add to &quot;in use&quot; queue
    this._connectionsInUse.push(connection);
};

&#x2F;**
 * &lt;p&gt;Processes a message by assigning it to a connection object and initiating
 * the sending process by setting the envelope&lt;&#x2F;p&gt;
 *
 * @param {Object} message MailComposer message object
 * @param {Object} connection &lt;code&gt;simplesmtp.connect&lt;&#x2F;code&gt; connection
 *&#x2F;
SMTPConnectionPool.prototype._processMessage = function(message, connection){
    connection.currentMessage = message;
    message.currentConnection = connection;

    &#x2F;&#x2F; send envelope
    connection.useEnvelope(message.getEnvelope());
};

&#x2F;**
 * &lt;p&gt;Will be fired on &lt;code&gt;&#x27;idle&#x27;&lt;&#x2F;code&gt; events by the connection, if
 * there&#x27;s a message currently in queue&lt;&#x2F;p&gt;
 *
 * @event
 * @param {Object} connection Connection object that fired the event
 *&#x2F;
SMTPConnectionPool.prototype._onConnectionIdle = function(connection){

    var message = this._messageQueue.shift();

    if(message){
        this._processMessage(message, connection);
    }else{
        for(var i=0, len = this._connectionsInUse.length; i&lt;len; i++){
            if(this._connectionsInUse[i] == connection){
                this._connectionsInUse.splice(i,1); &#x2F;&#x2F; remove from list
                break;
            }
        }
        this._connectionsAvailable.push(connection);
    }
};

&#x2F;**
 * &lt;p&gt;Will be called when not all recipients were accepted&lt;&#x2F;p&gt;
 *
 * @event
 * @param {Object} connection Connection object that fired the event
 * @param {Array} addresses Failed addresses as an array of strings
 *&#x2F;
SMTPConnectionPool.prototype._onConnectionRCPTFailed = function(connection, addresses){
    if(connection.currentMessage){
        connection.currentMessage.failedRecipients = addresses;
    }
};

&#x2F;**
 * &lt;p&gt;Will be called when the client is waiting for a message to deliver&lt;&#x2F;p&gt;
 *
 * @event
 * @param {Object} connection Connection object that fired the event
 *&#x2F;
SMTPConnectionPool.prototype._onConnectionMessage = function(connection){
    if(connection.currentMessage){
        connection.currentMessage.streamMessage();
        connection.currentMessage.pipe(connection);
    }
};

&#x2F;**
 * &lt;p&gt;Will be called when a message has been delivered&lt;&#x2F;p&gt;
 *
 * @event
 * @param {Object} connection Connection object that fired the event
 * @param {Boolean} success True if the message was queued by the SMTP server
 * @param {String} message Last message received from the server
 *&#x2F;
SMTPConnectionPool.prototype._onConnectionReady = function(connection, success, message){
    var error, responseObj = {};
    if(connection.currentMessage &amp;&amp; connection.currentMessage.returnCallback){
        if(success){

            if(connection.currentMessage.failedRecipients){
                responseObj.failedRecipients = connection.currentMessage.failedRecipients;
            }
            if(message){
                responseObj.message = message;
            }

            connection.currentMessage.returnCallback(null, responseObj);

        }else{
            error = new Error(&quot;Message delivery failed&quot;);
            error.name = &quot;DeliveryError&quot;;
            connection.currentMessage.returnCallback(error);
        }
    }
    connection.currentMessage = false;
};

&#x2F;**
 * &lt;p&gt;Will be called when an error occurs&lt;&#x2F;p&gt;
 *
 * @event
 * @param {Object} connection Connection object that fired the event
 * @param {Object} error Error object
 *&#x2F;
SMTPConnectionPool.prototype._onConnectionError = function(connection, error){
    var message = connection.currentMessage;
    connection.currentMessage = false;

    &#x2F;&#x2F; clear a first message from the list, otherwise an infinite loop will emerge
    if(!message){
        message = this._messageQueue.shift();
    }

    if(message &amp;&amp; message.returnCallback){
        message.returnCallback(error);
    }
};

&#x2F;**
 * &lt;p&gt;Will be called when a connection to the client is closed&lt;&#x2F;p&gt;
 *
 * @event
 * @param {Object} connection Connection object that fired the event
 *&#x2F;
SMTPConnectionPool.prototype._onConnectionEnd = function(connection){
    var removed = false, i, len;

    &#x2F;&#x2F; if in &quot;available&quot; list, remove
    for(i=0, len = this._connectionsAvailable.length; i&lt;len; i++){
        if(this._connectionsAvailable[i] == connection){
            this._connectionsAvailable.splice(i,1); &#x2F;&#x2F; remove from list
            removed = true;
            break;
        }
    }

    if(!removed){
        &#x2F;&#x2F; if in &quot;in use&quot; list, remove
        for(i=0, len = this._connectionsInUse.length; i&lt;len; i++){
            if(this._connectionsInUse[i] == connection){
                this._connectionsInUse.splice(i,1); &#x2F;&#x2F; remove from list
                removed = true;
                break;
            }
        }
    }

    &#x2F;&#x2F; if there&#x27;s still unprocessed mail and available connection slots, create
    &#x2F;&#x2F; a new connection
    if(this._messageQueue.length &amp;&amp;
      this._connectionsInUse.length + this._connectionsAvailable.length &lt; this.options.maxConnections){
        this._createConnection();
    }
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
