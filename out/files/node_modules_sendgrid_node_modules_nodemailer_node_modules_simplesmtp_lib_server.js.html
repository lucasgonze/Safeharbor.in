<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>node_modules&#x2F;sendgrid&#x2F;node_modules&#x2F;nodemailer&#x2F;node_modules&#x2F;simplesmtp&#x2F;lib&#x2F;server.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.1&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.5.1&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Enables filtering in class lists..html">Enables filtering in class lists.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of currency amounts.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;
POSIX LC_MONETARY&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of dates and times.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;
POSIX LC_TIME&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;..html">Namespace container for the JsWorld library objects..Class for localised formatting of numbers.

&lt;p&gt;See: &lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;
POSIX LC_NUMERIC&lt;&#x2F;a&gt;.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings..html">Namespace container for the JsWorld library objects..Class for parsing localised currency amount strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised date and time strings..html">Namespace container for the JsWorld library objects..Class for parsing localised date and time strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Class for parsing localised number strings..html">Namespace container for the JsWorld library objects..Class for parsing localised number strings.</a></li>
            
                <li><a href="..&#x2F;classes/Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;.html">Namespace container for the JsWorld library objects..Represents a POSIX-style locale with its numeric, monetary and date&#x2F;time 
properties. Also provides a set of locale helper methods.

&lt;p&gt;The locale properties follow the POSIX standards:

&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_04&quot;&gt;POSIX LC_NUMERIC&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;009695399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_03&quot;&gt;POSIX LC_MONETARY&lt;&#x2F;a&gt;
    &lt;li&gt;&lt;a href=&quot;http:&#x2F;&#x2F;www.opengroup.org&#x2F;onlinepubs&#x2F;000095399&#x2F;basedefs&#x2F;xbd_chap07.html#tag_07_03_05&quot;&gt;POSIX LC_TIME&lt;&#x2F;a&gt;
&lt;&#x2F;ul&gt;</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: node_modules&#x2F;sendgrid&#x2F;node_modules&#x2F;nodemailer&#x2F;node_modules&#x2F;simplesmtp&#x2F;lib&#x2F;server.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
 * @fileOverview This is the main file for the simplesmtp library to create custom SMTP servers
 * @author &lt;a href=&quot;mailto:andris@node.ee&quot;&gt;Andris Reinman&lt;&#x2F;a&gt;
 *&#x2F;

var RAIServer = require(&quot;rai&quot;).RAIServer,
    EventEmitter = require(&#x27;events&#x27;).EventEmitter,
    oslib = require(&#x27;os&#x27;),
    utillib = require(&quot;util&quot;),
    dnslib = require(&quot;dns&quot;);

&#x2F;&#x2F; expose to the world
module.exports = function(options){
    return new SMTPServer(options);
};

&#x2F;**
 * &lt;p&gt;Constructs a SMTP server&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;Possible options are:&lt;&#x2F;p&gt;
 * 
 * &lt;ul&gt;
 *     &lt;li&gt;&lt;b&gt;name&lt;&#x2F;b&gt; - the hostname of the server, will be used for
 *         informational messages&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;debug&lt;&#x2F;b&gt; - if set to true, print out messages about the connection&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;timeout&lt;&#x2F;b&gt; - client timeout in milliseconds, defaults to 60 000&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;secureConnection&lt;&#x2F;b&gt; - start a server on secure connection&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;SMTPBanner&lt;&#x2F;b&gt; - greeting banner that is sent to the client on connection&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;requireAuthentication&lt;&#x2F;b&gt; - if set to true, require that the client
 *         must authenticate itself&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;enableAuthentication&lt;&#x2F;b&gt; - if set to true, client may authenticate itself but don&#x27;t have to&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;validateSender&lt;&#x2F;b&gt; - if set to true, emit &lt;code&gt;&#x27;validateSender&#x27;&lt;&#x2F;code&gt;
 *         with &lt;code&gt;envelope&lt;&#x2F;code&gt;, &lt;code&gt;email&lt;&#x2F;code&gt; and &lt;code&gt;callback&lt;&#x2F;code&gt; when the client
 *         enters &lt;code&gt;MAIL FROM:&amp;lt;address&amp;gt;&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;validateRecipients&lt;&#x2F;b&gt; - if set to true, emit &lt;code&gt;&#x27;validateRecipient&#x27;&lt;&#x2F;code&gt;
 *         with &lt;code&gt;envelope&lt;&#x2F;code&gt;, &lt;code&gt;email&lt;&#x2F;code&gt; and &lt;code&gt;callback&lt;&#x2F;code&gt; when the client
 *         enters &lt;code&gt;RCPT TO:&amp;lt;address&amp;gt;&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;maxSize&lt;&#x2F;b&gt; - maximum size of an e-mail in bytes&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;credentials&lt;&#x2F;b&gt; - TLS credentials&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;authMethods&lt;&#x2F;b&gt; - allowed authentication methods, defaults to &lt;code&gt;[&quot;PLAIN&quot;, &quot;LOGIN&quot;]&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
 *     &lt;li&gt;&lt;b&gt;disableEHLO&lt;&#x2F;b&gt; - if set, support HELO only&lt;&#x2F;li&gt;
 * &lt;&#x2F;ul&gt;
 * 
 * @constructor
 * @namespace SMTP Server module
 * @param {Object} [options] Options object
 *&#x2F;
function SMTPServer(options){
    EventEmitter.call(this);
    
    this.options = options || {};
    this.options.name = this.options.name || (oslib.hostname &amp;&amp; oslib.hostname()) ||
               (oslib.getHostname &amp;&amp; oslib.getHostname()) ||
               &quot;127.0.0.1&quot;;

    this.options.authMethods = (this.options.authMethods || [&quot;PLAIN&quot;, &quot;LOGIN&quot;]).map(
        function(auth){
            return auth.toUpperCase().trim();
        });
    
    this.options.disableEHLO = !!this.options.disableEHLO;

    this.SMTPServer = new RAIServer({
        secureConnection: !!this.options.secureConnection,
        timeout: this.options.timeout || 60*1000,
        disconnectOnTimeout: false,
        debug: !!this.options.debug
    });
    
    this.SMTPServer.on(&quot;connect&quot;, this._createSMTPServerConnection.bind(this));
}
utillib.inherits(SMTPServer, EventEmitter);

&#x2F;**
 * Server starts listening on defined port and hostname
 * 
 * @param {Number} port The port number to listen
 * @param {String} [host] The hostname to listen
 * @param {Function} callback The callback function to run when the server is listening
 *&#x2F;
SMTPServer.prototype.listen = function(port, host, callback){
    this.SMTPServer.listen(port, host, callback);
};

&#x2F;**
 * &lt;p&gt;Closes the server&lt;&#x2F;p&gt;
 * 
 * @param {Function} callback The callback function to run when the server is closed
 *&#x2F;
SMTPServer.prototype.end = function(callback){
    this.SMTPServer.end(callback);
};

&#x2F;**
 * &lt;p&gt;Creates a new {@link SMTPServerConnection} object and links the main server with
 * the client socket&lt;&#x2F;p&gt;
 * 
 * @param {Object} client RAISocket object to a client
 *&#x2F;
SMTPServer.prototype._createSMTPServerConnection = function(client){
    new SMTPServerConnection(this, client);
};

&#x2F;**
 * &lt;p&gt;Sets up a handler for the connected client&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;Restarts the state and sets up event listeners for client actions&lt;&#x2F;p&gt;
 * 
 * @constructor
 * @param {Object} server {@link SMTPServer} instance
 * @param {Object} client RAISocket instance for the client
 *&#x2F;
function SMTPServerConnection(server, client){
    this.server = server;
    this.client = client;

    this.init();

    if(this.server.options.debug){
        console.log(&quot;Connection from&quot;, this.client.remoteAddress);
    }
    
    this.client.on(&quot;timeout&quot;, this._onTimeout.bind(this));
    this.client.on(&quot;error&quot;, this._onError.bind(this));
    this.client.on(&quot;command&quot;, this._onCommand.bind(this));
    this.client.on(&quot;end&quot;, this._onEnd.bind(this));
    
    this.client.on(&quot;data&quot;, this._onData.bind(this));
    this.client.on(&quot;ready&quot;, this._onDataReady.bind(this));
    
    &#x2F;&#x2F; Send the greeting banner
    this.client.send(&quot;220 &quot;+this.server.options.name+&quot; &quot;+(this.server.options.SMTPBanner || &quot;ESMTP node.js simplesmtp&quot;));
}

&#x2F;**
 * &lt;p&gt;Reset the envelope state&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;If &lt;code&gt;keepAuthData&lt;&#x2F;code&gt; is set to true, then doesn&#x27;t remove
 * authentication data&lt;&#x2F;p&gt;
 * 
 * @param {Boolean} [keepAuthData=false] If set to true keep authentication data
 *&#x2F;
SMTPServerConnection.prototype.init = function(keepAuthData){
    this.envelope = {from: &quot;&quot;, to:[], date: new Date()};
    
    if(this.hostNameAppearsAs){
        this.envelope.host = this.hostNameAppearsAs;
    }
    
    if(this.client.remoteAddress){
        this.envelope.remoteAddress = this.client.remoteAddress;
    }
    
    if(!keepAuthData){
        this.authentication = {
            username: false,
            authenticated: false,
            state: &quot;NORMAL&quot;
        };
    }
    
    this.envelope.authentication = this.authentication;
};

&#x2F;**
 * &lt;p&gt;Sends a message to the client and closes the connection&lt;&#x2F;p&gt;
 * 
 * @param {String} [message] if set, send it to the client before disconnecting
 *&#x2F;
SMTPServerConnection.prototype.end = function(message){
    if(message){
        this.client.send(message);
    }
    this.client.end();
};

&#x2F;**
 * &lt;p&gt;Will be called when the connection to the client is closed&lt;&#x2F;p&gt;
 * 
 * @event
 *&#x2F;
SMTPServerConnection.prototype._onEnd = function(){
    if(this.server.options.debug){
        console.log(&quot;Connection closed to&quot;, this.client.remoteAddress);
    }
    this.server.emit(&quot;close&quot;, this.envelope);
};

&#x2F;**
 * &lt;p&gt;Will be called when timeout occurs&lt;&#x2F;p&gt;
 * 
 * @event
 *&#x2F;
SMTPServerConnection.prototype._onTimeout = function(){
    this.end(&quot;421 4.4.2 &quot;+this.server.options.name+&quot; Error: timeout exceeded&quot;);
};

&#x2F;**
 * &lt;p&gt;Will be called when an error occurs&lt;&#x2F;p&gt;
 * 
 * @event
 *&#x2F;
SMTPServerConnection.prototype._onError = function(){
    this.end(&quot;421 4.4.2 &quot;+this.server.options.name+&quot; Error: client error&quot;);
};

&#x2F;**
 * &lt;p&gt;Will be called when a command is received from the client&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;If there&#x27;s curently an authentication process going on, route
 * the data to &lt;code&gt;_handleAuthLogin&lt;&#x2F;code&gt;, otherwise act as
 * defined&lt;&#x2F;p&gt;
 * 
 * @event
 * @param {String} command Command
 * @param {Buffer} command Payload related to the command
 *&#x2F;
SMTPServerConnection.prototype._onCommand = function(command, payload){

    if(this.authentication.state == &quot;AUTHENTICATING&quot;){
        this._handleAuthLogin(command);
        return;
    }
    
    switch((command || &quot;&quot;).toString().trim().toUpperCase()){
        
        &#x2F;&#x2F; Should not occur too often 
        case &quot;HELO&quot;:
            this._onCommandHELO(payload.toString(&quot;utf-8&quot;).trim());
            break;
            
        &#x2F;&#x2F; Lists server capabilities
        case &quot;EHLO&quot;:
            if(!this.server.options.disableEHLO){
                this._onCommandEHLO(payload.toString(&quot;utf-8&quot;).trim());
            }else{
                this.client.send(&quot;502 5.5.2 Error: command not recognized&quot;);
            }
            break;
            
        &#x2F;&#x2F; Closes the connection
        case &quot;QUIT&quot;:
            this.end(&quot;221 2.0.0 Goodbye!&quot;);
            break;

        &#x2F;&#x2F; Resets the current state
        case &quot;RSET&quot;:
            this._onCommandRSET();
            break;
        
        &#x2F;&#x2F; Doesn&#x27;t work for spam related purposes
        case &quot;VRFY&quot;:
            this.client.send(&quot;252 2.1.5 Send some mail, I&#x27;ll try my best&quot;);
            break;
        
        &#x2F;&#x2F; Initiate an e-mail by defining a sender
        case &quot;MAIL&quot;:
            this._onCommandMAIL(payload.toString(&quot;utf-8&quot;).trim());
            break;
        
        &#x2F;&#x2F; Add recipients to the e-mail envelope
        case &quot;RCPT&quot;:
            this._onCommandRCPT(payload.toString(&quot;utf-8&quot;).trim());
            break;
        
        &#x2F;&#x2F; Authenticate if needed
        case &quot;AUTH&quot;:
            this._onCommandAUTH(payload);
            break;
        
        &#x2F;&#x2F; Start accepting binary data stream
        case &quot;DATA&quot;:
            this._onCommandDATA();
            break;
        
        &#x2F;&#x2F; Upgrade connection to secure TLS
        case &quot;STARTTLS&quot;:
            this._onCommandSTARTTLS();
            break;
            
        &#x2F;&#x2F; Display an error on anything else
        default:
            this.client.send(&quot;502 5.5.2 Error: command not recognized&quot;);
    }  
};

&#x2F;**
 * &lt;p&gt;Initiate an e-mail by defining a sender.&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;This doesn&#x27;t work if authorization is required but the client is
 * not logged in yet.&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;If &lt;code&gt;validateSender&lt;&#x2F;code&gt; option is set to true, then emits
 * &lt;code&gt;&#x27;validateSender&#x27;&lt;&#x2F;code&gt; and wait for the callback before moving
 * on&lt;&#x2F;p&gt;
 * 
 * @param {String} mail Address payload in the form of &quot;FROM:&amp;lt;address&amp;gt;&quot;
 *&#x2F;
SMTPServerConnection.prototype._onCommandMAIL = function(mail){
    var match, email, domain;
    
    if(!this.hostNameAppearsAs){
        return this.client.send(&quot;503 5.5.1 Error: send HELO&#x2F;EHLO first&quot;);
    }
    
    if(this.server.options.requireAuthentication &amp;&amp; !this.authentication.authenticated){
        return this.client.send(&quot;530 5.5.1 Authentication Required&quot;);
    }
    
    if(this.envelope.from){
        return this.client.send(&quot;503 5.5.1 Error: nested MAIL command&quot;);
    }
    
    if(!(match = mail.match(&#x2F;^from\:\s*&lt;([^@&gt;]+\@([^@&gt;]+))&gt;$&#x2F;i))){
        return this.client.send(&quot;501 5.1.7 Bad sender address syntax&quot;);
    }
    
    email = match[1] || &quot;&quot;;
    domain = (match[2] || &quot;&quot;).toLowerCase();
    
    dnslib.resolveMx(domain, (function(err, addresses){
        if(err || !addresses || !addresses.length){
            return this.client.send(&quot;450 4.1.8 &lt;&quot;+email+&quot;&gt;: Sender address rejected: Domain not found&quot;);
        }
        
        if(this.server.options.validateSender){
            this.server.emit(&quot;validateSender&quot;, this.envelope, email, (function(err){
                if(err){
                    return this.client.send(&quot;550 5.1.1 &lt;&quot;+email+&quot;&gt;: Sender address rejected: User unknown in local sender table&quot;);
                }
                
                &#x2F;&#x2F; force domain part to be lowercase
                email = email.substr(0, email.length - domain.length) + domain;
                this.envelope.from = email;
                this.client.send(&quot;250 2.1.0 Ok&quot;);
        
            }).bind(this));
        }else{
            &#x2F;&#x2F; force domain part to be lowercase
            email = email.substr(0, email.length - domain.length) + domain;
            this.envelope.from = email;
            this.client.send(&quot;250 2.1.0 Ok&quot;);
        }
    }).bind(this));  
};

&#x2F;**
 * &lt;p&gt;Add recipients to the e-mail envelope&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;This doesn&#x27;t work if &lt;code&gt;MAIL&lt;&#x2F;code&gt; command is not yet executed&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;If &lt;code&gt;validateRecipients&lt;&#x2F;code&gt; option is set to true, then emits
 * &lt;code&gt;&#x27;validateRecipient&#x27;&lt;&#x2F;code&gt; and wait for the callback before moving
 * on&lt;&#x2F;p&gt;
 * 
 * @param {String} mail Address payload in the form of &quot;TO:&amp;lt;address&amp;gt;&quot;
 *&#x2F;
SMTPServerConnection.prototype._onCommandRCPT = function(mail){
    var match, email, domain;
    
    if(!this.envelope.from){
        return this.client.send(&quot;503 5.5.1 Error: need MAIL command&quot;);
    }
    
    if(!(match = mail.match(&#x2F;^to\:\s*&lt;([^@&gt;]+\@([^@&gt;]+))&gt;$&#x2F;i))){
        return this.client.send(&quot;501 5.1.7 Bad recipient address syntax&quot;);
    }
    
    email = match[1] || &quot;&quot;;
    domain = (match[2] || &quot;&quot;).toLowerCase();
    
    dnslib.resolveMx(domain, (function(err, addresses){
        if(err || !addresses || !addresses.length){
            return this.client.send(&quot;450 4.1.8 &lt;&quot;+email+&quot;&gt;: Recipient address rejected: Domain not found&quot;);
        }
        
        if(this.server.options.validateRecipients){
            this.server.emit(&quot;validateRecipient&quot;, this.envelope, email, (function(err){
                if(err){
                    return this.client.send(&quot;550 5.1.1 &lt;&quot;+email+&quot;&gt;: Recipient address rejected: User unknown in local recipient table&quot;);
                }
                
                &#x2F;&#x2F; force domain part to be lowercase
                email = email.substr(0, email.length - domain.length) + domain;
                
                &#x2F;&#x2F; add to recipients list
                if(this.envelope.to.indexOf(email)&lt;0){
                    this.envelope.to.push(email);
                }
                this.client.send(&quot;250 2.1.0 Ok&quot;);
            }).bind(this));
        }else{
            &#x2F;&#x2F; force domain part to be lowercase
            email = email.substr(0, email.length - domain.length) + domain;
            
            &#x2F;&#x2F; add to recipients list
            if(this.envelope.to.indexOf(email)&lt;0){
                this.envelope.to.push(email);
            }
            this.client.send(&quot;250 2.1.0 Ok&quot;);
        }
    }).bind(this));  
};

&#x2F;**
 * &lt;p&gt;Switch to data mode and starts waiting for a binary data stream. Emits
 * &lt;code&gt;&#x27;startData&#x27;&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;If &lt;code&gt;RCPT&lt;&#x2F;code&gt; is not yet run, stop&lt;&#x2F;p&gt;
 *&#x2F;
SMTPServerConnection.prototype._onCommandDATA = function(){
    
    if(!this.envelope.to.length){
        return this.client.send(&quot;503 5.5.1 Error: need RCPT command&quot;);
    }
    
    this.client.startDataMode();
    this.client.send(&quot;354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;&quot;);
    this.server.emit(&quot;startData&quot;, this.envelope);
};

&#x2F;**
 * &lt;p&gt;Resets the current state - e-mail data and authentication info&lt;&#x2F;p&gt;
 *&#x2F;
SMTPServerConnection.prototype._onCommandRSET = function(){
    this.init();
    this.client.send(&quot;250 2.0.0 Ok&quot;);
};

&#x2F;**
 * &lt;p&gt;If the server is in secure connection mode, start the authentication
 * process. Param &lt;code&gt;payload&lt;&#x2F;code&gt; defines the authentication mechanism.&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;Currently supported - PLAIN and LOGIN. There is no need for more
 * complicated mechanisms (different CRAM versions etc.) since authentication
 * is only done in secure connection mode&lt;&#x2F;p&gt;
 * 
 * @param {Buffer} payload Defines the authentication mechanism
 *&#x2F;
SMTPServerConnection.prototype._onCommandAUTH = function(payload){
    var method;
    
    if(!this.server.options.requireAuthentication &amp;&amp; !this.server.options.enableAuthentication){
        return this.client.send(&quot;503 5.5.1 Error: authentication not enabled&quot;);
    }
    
    if(!this.client.secureConnection){
        return this.client.send(&quot;530 5.7.0 Must issue a STARTTLS command first&quot;);
    }
    
    if(this.authentication.authenticated){
        return this.client.send(&quot;503 5.7.0 No identity changes permitted&quot;);
    }
    
    payload = payload.toString(&quot;utf-8&quot;).trim().split(&quot; &quot;);
    method = payload.shift().trim().toUpperCase();
    
    if(this.server.options.authMethods.indexOf(method)&lt;0){
        return this.client.send(&quot;535 5.7.8 Error: authentication failed: no mechanism available&quot;);
    }
    
    switch(method){
        case &quot;PLAIN&quot;:
            this._handleAuthPlain(payload);
            break;
        case &quot;LOGIN&quot;:
            this._handleAuthLogin();
            break;
    }
};

&#x2F;**
 * &lt;p&gt;Upgrade the connection to a secure TLS connection&lt;&#x2F;p&gt;
 *&#x2F;
SMTPServerConnection.prototype._onCommandSTARTTLS = function(){
    if(this.client.secureConnection){
        return this.client.send(&quot;554 5.5.1 Error: TLS already active&quot;);
    }
    
    this.client.send(&quot;220 2.0.0 Ready to start TLS&quot;);
    
    this.client.startTLS(this.server.options.credentials, (function(){
        &#x2F;&#x2F; Connection secured
        &#x2F;&#x2F; nothing to do here, since it is the client that should 
        &#x2F;&#x2F; make the next move
    }).bind(this));
};

&#x2F;**
 * &lt;p&gt;Retrieve hostname from the client. Not very important, since client
 * IP is already known and the client can send fake data&lt;&#x2F;p&gt;
 * 
 * @param {String} host Hostname of the client
 *&#x2F;
SMTPServerConnection.prototype._onCommandHELO = function(host){
    if(!host){
        return this.client.send(&quot;501 Syntax: EHLO hostname&quot;);
    }else{
        this.hostNameAppearsAs = host;
        this.envelope.host = host;
    }
    this.client.send(&quot;250 &quot;+this.server.options.name+&quot; at your service, [&quot;+
        this.client.remoteAddress+&quot;]&quot;);
};

&#x2F;**
 * &lt;p&gt;Retrieve hostname from the client. Not very important, since client
 * IP is already known and the client can send fake data&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;Additionally displays server capability list to the client&lt;&#x2F;p&gt;
 * 
 * @param {String} host Hostname of the client 
 *&#x2F;
SMTPServerConnection.prototype._onCommandEHLO = function(host){
    var response = [this.server.options.name+&quot; at your service, [&quot;+
        this.client.remoteAddress+&quot;]&quot;, &quot;8BITMIME&quot;, &quot;ENHANCEDSTATUSCODES&quot;];
    
    if(this.server.options.maxSize){
        response.push(&quot;SIZE &quot;+this.server.options.maxSize);
    }
    
    if(this.client.secureConnection &amp;&amp; (this.server.options.requireAuthentication || this.server.options.enableAuthentication)){
        response.push(&quot;AUTH &quot;+this.server.options.authMethods.join(&quot; &quot;));
        response.push(&quot;AUTH=&quot;+this.server.options.authMethods.join(&quot; &quot;));
    }
    
    if(!this.client.secureConnection){
        response.push(&quot;STARTTLS&quot;);
    }
    
    if(!host){
        return this.client.send(&quot;501 Syntax: EHLO hostname&quot;);
    }else{
        this.hostNameAppearsAs = host;
        this.envelope.host = host;
    }
    
    this.client.send(response.map(function(feature, i, arr){
        return &quot;250&quot;+(i&lt;arr.length-1?&quot;-&quot;:&quot; &quot;)+feature;
    }).join(&quot;\r\n&quot;));    
};

&#x2F;**
 * &lt;p&gt;Detect login information from the payload and initiate authentication
 * by emitting &lt;code&gt;&#x27;authorizeUser&#x27;&lt;&#x2F;code&gt; and waiting for its callback&lt;&#x2F;p&gt;
 * 
 * @param {Buffer} payload AUTH PLAIN login information
 *&#x2F;
SMTPServerConnection.prototype._handleAuthPlain = function(payload){
    var userdata = new Buffer(payload.join(&quot; &quot;), &quot;base64&quot;), password;
    userdata = userdata.toString(&quot;utf-8&quot;).split(&quot;\u0000&quot;);
    this.authentication.username = userdata[1] || userdata[0] || &quot;&quot;;
    password = userdata[2] || &quot;&quot;;
    
    this.server.emit(&quot;authorizeUser&quot;, 
        this.envelope, 
        this.authentication.username, 
        password, 
        (function(err, success){
            if(err || !success){
                this.authentication.authenticated = false;
                this.authentication.username = false;
                this.authentication.state = &quot;NORMAL&quot;;
                return this.client.send(&quot;535 5.7.8 Error: authentication failed: generic failure&quot;);
            }
            this.client.send(&quot;235 2.7.0 Authentication successful&quot;);
            this.authentication.authenticated = true;
            this.authentication.state = &quot;AUTHENTICATED&quot;;
        }).bind(this));
};

&#x2F;**
 * &lt;p&gt;Sets authorization state to &quot;AUTHENTICATING&quot; and reuqests for the
 * username and password from the client&lt;&#x2F;p&gt;
 * 
 * &lt;p&gt;If username and password are set initiate authentication
 * by emitting &lt;code&gt;&#x27;authorizeUser&#x27;&lt;&#x2F;code&gt; and waiting for its callback&lt;&#x2F;p&gt;
 * 
 * @param {Buffer} payload AUTH LOGIN login information
 *&#x2F;
SMTPServerConnection.prototype._handleAuthLogin = function(payload){
    if(this.authentication.state == &quot;NORMAL&quot;){
        this.authentication.state = &quot;AUTHENTICATING&quot;;
        this.client.send(&quot;334 VXNlcm5hbWU6&quot;);
    }else if(this.authentication.state == &quot;AUTHENTICATING&quot;){
        if(this.authentication.username === false){
            this.authentication.username = new Buffer(payload, &quot;base64&quot;).toString(&quot;utf-8&quot;);
            this.client.send(&quot;334 UGFzc3dvcmQ6&quot;);
        }else{
            this.authentication.state = &quot;VERIFYING&quot;;
            this.server.emit(&quot;authorizeUser&quot;, 
                this.envelope, 
                this.authentication.username, 
                new Buffer(payload, &quot;base64&quot;).toString(&quot;utf-8&quot;), 
                (function(err, success){
                    if(err || !success){
                        this.authentication.authenticated = false;
                        this.authentication.username = false;
                        this.authentication.state = &quot;NORMAL&quot;;
                        return this.client.send(&quot;535 5.7.8 Error: authentication failed: generic failure&quot;);
                    }
                    this.client.send(&quot;235 2.7.0 Authentication successful&quot;);
                    this.authentication.authenticated = true;
                    this.authentication.state = &quot;AUTHENTICATED&quot;;
                }).bind(this));
        }
        
    }
};

&#x2F;**
 * &lt;p&gt;Emits the data received from the client with &lt;code&gt;&#x27;data&#x27;&lt;&#x2F;code&gt;
 * 
 * @event
 * @param {Buffer} chunk Binary data sent by the client on data mode
 *&#x2F;
SMTPServerConnection.prototype._onData = function(chunk){
    this.server.emit(&quot;data&quot;, this.envelope, chunk);
};

&#x2F;**
 * &lt;p&gt;If the data stream ends, emit &lt;code&gt;&#x27;dataReady&#x27;&lt;&#x2F;code&gt;and wait for
 * the callback.&lt;&#x2F;p&gt;
 * 
 * @event
 *&#x2F;
SMTPServerConnection.prototype._onDataReady = function(){
    this.server.emit(&quot;dataReady&quot;, this.envelope, (function(err, code){
        this.init(true); &#x2F;&#x2F;reset state, keep auth data
        
        if(err){
            this.client.send(&quot;550 FAILED&quot;);
        }else{
            this.client.send(&quot;250 2.0.0 Ok: queued as &quot;+(code || &quot;FOOBARBAZ&quot;));
        }
        
    }).bind(this));
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
